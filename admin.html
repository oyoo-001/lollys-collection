<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Lolly's Collection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- Dark Pink & White Color Theme --- */
        :root { 
            --color-bg-light: #FFFFFF;
            --color-bg-page: #F4F4F9;
            --color-pink-dark: #C2185B;
            --color-pink-accent: #E91E63;
            --color-text-dark: #333333;
            --color-text-light: #F4F4F9;
            --color-text-subtle: #757575;
            --color-border-light: #F0F0F0;
            --color-border-medium: #E0E0E0;
            --color-shadow: rgba(0,0,0,0.08);

            /* Status Colors */
            --color-warning: #ffc107; /* Pending/Low Stock */
            --color-success: #28a745; /* In Stock/Shipped/Completed/Active */
            --color-danger: #dc3545; /* Out of Stock/Delete/Deactivated */
            --color-info: #17a2b8; /* Contacted */
            --color-primary: var(--color-pink-accent);

            /* Typography */
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Poppins', sans-serif;
        }

        /* --- Global Styles & Layout (Existing styles omitted for brevity, ensure all are included) --- */
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }
        h1, h2 {
            font-family: var(--font-heading);
            color: var(--color-pink-dark);
        }
        h2 {
            font-size: 2.2rem;
            margin-bottom: 30px;
        }
        h3 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            color: var(--color-text-dark);
            margin-top: 0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--color-border-medium);
        }
        
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: var(--color-text-light);
            font-weight: 500;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Starts hidden */
            transform: translateX(100%);
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background-color: var(--color-success); }
        .toast.error { background-color: var(--color-danger); }
        .toast.info { background-color: var(--color-info); }
        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 250px;
            background-color: var(--color-pink-dark);
            color: var(--color-text-light);
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            position: fixed;
            height: 100%;
            overflow-y: auto;
            transition: width 0.3s;
        }
        .sidebar-header {
            text-align: center;
            color: var(--color-text-light);
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 1.5rem;
            font-family: var(--font-heading);
        }
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--color-text-light);
            transition: background-color 0.3s, color 0.3s;
            font-size: 1rem;
            font-weight: 500;
        }
        .sidebar-nav li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .sidebar-nav li a:hover,
        .sidebar-nav li a.active {
            background-color: var(--color-pink-accent);
            color: var(--color-bg-light);
        }
        
        /* --- Main Content Area & Cards --- */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
        }
        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        .content-section.active {
            display: block;
        }
        .card {
            background-color: var(--color-bg-light);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--color-shadow);
            margin-bottom: 30px;
        }
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Dashboard Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            padding: 20px;
            background-color: var(--color-bg-light);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--color-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid var(--color-pink-accent);
        }
        .stat-card-info {
            flex-grow: 1;
        }
        .stat-card-info p {
            margin: 0;
            font-size: 1rem;
            color: var(--color-text-subtle);
        }
        .stat-card-info h4 {
            margin: 5px 0 0;
            font-size: 2rem;
            font-family: var(--font-heading);
            color: var(--color-pink-dark);
        }
        .stat-card i {
            font-size: 2.5rem;
            color: var(--color-pink-accent);
            opacity: 0.7;
        }
        
        /* --- Input and Buttons --- */
        input[type="text"], 
        input[type="number"], 
        input[type="email"], 
        textarea, 
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border-medium);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            font-family: var(--font-body);
        }
        /* Specific styling for file input to make it look nicer */
        input[type="file"] {
            padding: 10px;
            background-color: var(--color-bg-page);
            border: 1px dashed var(--color-pink-accent);
            cursor: pointer;
        }

        .submit-button, .action-button, .action-btn {
            background-color: var(--color-pink-accent);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .submit-button:hover, .action-button:hover, .action-btn:hover {
            background-color: var(--color-pink-dark);
            transform: translateY(-1px);
        }
        
        /* Form Row Grouping for Responsiveness */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-row > div {
            flex: 1;
        }
        .form-row label {
             margin-bottom: 5px; 
             display: block;
             font-weight: 500;
        }
        .form-row input, .form-row select {
            margin-bottom: 0; 
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row input, .form-row select {
                margin-bottom: 15px; /* Restore margin on small screens for vertical stacking */
            }
        }
        
        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-border-light);
            font-size: 0.95rem;
        }
        .data-table th {
            background-color: var(--color-bg-page);
            color: var(--color-pink-dark);
            font-weight: 600;
            text-transform: uppercase;
        }
        .data-table tbody tr:hover {
             background-color: #fcfcfc;
             cursor: pointer;
        }
        .data-table .no-hover:hover {
             background-color: transparent;
             cursor: default;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-bg-light);
            text-align: center;
        }
        .status-badge.pending { background-color: var(--color-warning); color: var(--color-text-dark); }
        .status-badge.completed, .status-badge.delivered, .status-badge.active { 
            background-color: var(--color-success); 
            color: var(--color-bg-light); 
        }
        .status-badge.shipped { background-color: var(--color-info); }
        .status-badge.deactivated { 
            background-color: var(--color-danger); 
            color: var(--color-bg-light); 
        }


        /* Table Action Buttons & Modal */
        .table-action-btn {
            background: none;
            border: none;
            color: var(--color-pink-dark);
            cursor: pointer;
            margin-left: 5px;
            font-size: 1rem;
            transition: color 0.2s;
            padding: 5px;
            line-height: 1;
        }
        .table-action-btn:hover {
            color: var(--color-pink-accent);
        }
        .btn-complete { background-color: var(--color-success); color: white; padding: 6px 10px; font-size: 0.9rem; }
        .btn-complete:hover { background-color: #1e7e34; }
        .btn-view { color: var(--color-info); }
        
        /* NEW: Customer Status Toggle Button */
        .btn-toggle-status { 
            padding: 6px 10px; 
            font-size: 0.85rem; 
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-toggle-status.deactivate { 
            background-color: var(--color-danger); 
            color: white; 
        }
        .btn-toggle-status.activate { 
            background-color: var(--color-success); 
            color: white; 
        }

        
        /* --- Message Section Styles --- */
        .messages-grid {
            display: grid;
            /* Responsive grid: min 300px wide cards */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px;
            margin-top: 30px;
        }

        .message-card {
            background-color: var(--color-bg-light); /* Assuming white background */
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--color-pink-accent); /* Pink accent border */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px var(--color-shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* To push button to bottom */
        }

        .message-header {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .message-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--color-pink-dark);
        }

        .message-header p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            color: var(--color-text-subtle);
            overflow-wrap: break-word;
        }

        .message-body {
            flex-grow: 1; 
            font-size: 0.9rem;
            color: var(--color-text-dark);
            line-height: 1.5;
            margin-bottom: 15px;
            background-color: #fcfcfc;
            padding: 10px;
            border-radius: 4px;
            /* Limit height to prevent huge cards for long messages */
            max-height: 200px; 
            overflow-y: auto; 
        }

        .message-footer {
            text-align: right;
            font-size: 0.75rem;
            color: var(--color-text-subtle);
            margin-bottom: 10px; /* Space above the button */
        }
        
        .message-actions {
            text-align: right;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        /* Modal Styling (Order Details) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            /* Added for Auth Gate modal to center vertically as well */
            align-items: center; 
            justify-content: center; 
        }
        .modal-content {
            background-color: var(--color-bg-light);
            margin: 5% auto; 
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            position: relative;
        }
        /* Style for the new reply modal content */
        #reply-modal .modal-content {
             max-width: 550px;
        }
        .close-btn {
            color: var(--color-text-dark);
            float: right;
            font-size: 30px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted var(--color-border-medium);
        }
        .detail-item:last-of-type { border-bottom: none; }
        #modal-items-list {
            list-style: none;
            padding: 0;
        }
        #modal-items-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">Lolly's Admin</div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#dashboard" class="nav-link" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="#orders" class="nav-link active" data-target="orders"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                <li><a href="#products" class="nav-link" data-target="products"><i class="fas fa-boxes"></i> <span>Products</span></a></li>
                <li><a href="#customers" class="nav-link" data-target="customers"><i class="fas fa-users"></i> <span>Customers</span></a></li>
                <li><a href="#messages" class="nav-link" data-target="messages"><i class="fas fa-envelope"></i> <span>Messages</span></a></li>
                <li><a href="#settings" class="nav-link" data-target="settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                <li><a href="#" class="nav-link" id="logout-link" style="margin-top: 50px;"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        
        <section id="dashboard" class="content-section">
            <h2>
                <i class="fas fa-chart-line"></i> Dashboard Overview
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Total Customers</p>
                        <h4 id="stat-customers">...</h4>
                    </div>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Pending Orders</p>
                        <h4 id="stat-pending-orders">...</h4>
                    </div>
                    <i class="fas fa-hourglass-half" style="color: var(--color-warning);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Completed Orders</p>
                        <h4 id="stat-completed-orders">...</h4>
                    </div>
                    <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
                </div>
            </div>

            <div class="card">
                <h3>Monthly Sales Trend</h3>
                <div style="height: 300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            
        </section>

        <section id="orders" class="content-section active">
            <h2>
                <i class="fas fa-receipt"></i> Order Management
            </h2>
            
            <div class="card" style="margin-bottom: 40px;">
                <div class="flex-between">
                    <h3>Pending Orders</h3>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-orders-tbody">
                            <tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading pending orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Completed Orders</h3>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="completed-orders-tbody">
                            <tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading completed orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="products" class="content-section">
            <h2><i class="fas fa-boxes"></i> Product Management</h2>
            
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> Upload New Product</h3>
                <form id="product-upload-form">
                    
                    <label for="product-name">Product Name:</label>
                    <input type="text" id="product-name" name="name" required>

                    <div class="form-row">
                        <div>
                            <label for="product-price">Price ($):</label>
                            <input type="number" id="product-price" name="price" step="0.01" min="0.01" required>
                        </div>
                        <div>
                            <label for="product-category">Category:</label>
                            <select id="product-category" name="category" required>
                                <option value="" disabled selected>Select a Category</option>
                                <option value="Cap">Cap</option>
                                <option value="Topware">Topware</option>
                                <option value="Footwear">Footwear</option>
                                <option value="Dresses">Dresses</option>
                                <option value="Electronics">Electronics</option>
                                <option value="HomeDecor">Home Decor</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div id="toast-container">
                    </div> 
                    <div class="form-row">
                        <div>
                            <label for="product-image-file">Product Image (File Upload):</label>
                           <input type="file" name="productImage" id="image-upload" accept="image/*" required>
                            <p style="font-size: 0.8rem; color: var(--color-text-subtle); margin-top: 5px;">*This file will be sent as **`productImage`** to your API.</p>
                        </div>
                        <div>
                            <label for="product-guaranty">Warranty/Guaranty:</label>
                            <input type="text" id="product-guaranty" name="guaranty" placeholder="e.g., 1 Year Limited, 90 Days" required>
                        </div>
                    <div class="form-group">
                  <label for="product-stock">Stock Quantity</label>
                   <input type="number" id="product-stock" name="stock" min="0" value="1" required>
                  </div>
                    </div>

                    <label for="product-description">Description:</label>
                    <textarea id="product-description" name="description" rows="4" required></textarea>
                    
                    <button type="submit" class="submit-button" id="upload-btn"><i class="fas fa-upload"></i> Upload Product</button>
                    <p id="upload-status" style="margin-top: 15px; font-weight: 600;"></p>
                </form>
            </div>
           
            <div class="card">
    <h3><i class="fas fa-list"></i> Current Products List</h3>
    <div id="edit-product-form-container" class="card" style="display: none;">
    <h3><i class="fas fa-edit"></i> Edit Product Details</h3>
    <form id="edit-product-form">
        <input type="hidden" id="edit-product-id" name="id"> 
        <input type="hidden" id="edit-existing-image-url" name="existing_image_url"> 

        <div class="form-group-grid">
            <div class="form-group">
                <label for="edit-name">Name</label>
                <input type="text" id="edit-name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="edit-price">Price</label>
                <input type="number" id="edit-price" name="price" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="edit-category">Category</label>
                <input type="text" id="edit-category" name="category">
            </div>

            <div class="form-group">
                <label for="edit-stock">Stock Quantity</label>
                <input type="number" id="edit-stock" name="stock" min="0" required>
            </div>
        </div>

        <div class="form-group">
            <label for="edit-description">Description</label>
            <textarea id="edit-description" name="description"></textarea>
        </div>

        <div class="form-group">
            <label for="edit-product-image">Change Image (Optional)</label>
            <input type="file" id="edit-product-image" name="productImage" accept="image/*">
            <p>Current Image:</p>
            <img id="current-edit-image" src="" alt="Current Product Image" style="max-width: 100px; max-height: 100px; display: block; margin-top: 10px;">
        </div>

        <button type="submit" id="update-btn" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('edit-product-form-container').style.display='none'">Cancel</button>
    </form>
</div>
    <div id="product-list-container">
        <p id="loading-message">Loading existing products...</p> 

        <table class="product-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="products-table-body"> 
                </tbody>
        </table>
    </div>
</div>
        </section>
        
        <section id="messages" class="content-section">
            <h2><i class="fas fa-envelope-open-text"></i> Customer Contact Messages</h2>
            <div class="card">
                <div class="flex-between">
                    <h3>All Submissions</h3>
                </div>
                <div id="messages-list" class="messages-grid">
                    <p id="messages-loading">Loading messages...</p>
                    </div>
            </div>
        </section>
        <section id="customers" class="content-section">
            <h2><i class="fas fa-users"></i> Customer Management</h2>
            <div class="card">
                <div class="flex-between">
                    <h3>All Registered Customers</h3>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Date Registered</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody">
                            <tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading customer data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: var(--color-text-subtle); font-size: 0.9rem;">(Note: Passwords are securely kept and are NOT fetched or displayed. Status is managed here.)</p>
            </div>
        </section>
        
        <section id="settings" class="content-section">
            <h2><i class="fas fa-cog"></i> Application Settings</h2>
            <div class="card">
                <h3>General Configurations</h3>
                <p>This section is for site-wide settings like shipping fees, VAT rates, and payment gateway configuration.</p>
                <form>
                    <label for="shipping-fee">Default Shipping Fee ($):</label>
                    <input type="number" id="shipping-fee" value="5.00" step="0.01">
                    <label for="admin-email">Admin Contact Email:</label>
                    <input type="email" id="admin-email" value="support@lollyscollection.com">
                    <button type="submit" class="submit-button">Save Settings</button>
                </form>
            </div>
        </section>
         
        <footer style="text-align: center; color: var(--color-text-subtle); font-size: 0.85rem; padding-top: 20px;">
            &copy; 2025 Lolly's Collection Admin Pane | Developed by Byron Oyoo
        </footer>
    </main>
    
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-order-title">Order #<span id="modal-order-id"></span></h3>
            
            <div id="order-details-info">
                <div class="detail-item"><span>Customer Name:</span> <strong id="modal-customer-name"></strong></div>
                <div class="detail-item"><span>Contact Email:</span> <strong id="modal-customer-email"></strong></div>
                <div class="detail-item"><span>Delivery Location:</span> <strong id="modal-delivery-location"></strong></div>
                <div class="detail-item"><span>Order Date:</span> <strong id="modal-order-date"></strong></div>
            </div>

            <h3 style="margin-top: 25px;">Order Items</h3>
            <ul id="modal-items-list">
                </ul>

            <div class="detail-item" style="font-size: 1.2rem; margin-top: 20px; border-top: 2px solid var(--color-pink-accent);">
                <span>Grand Total:</span> <strong id="modal-total-amount"></strong>
            </div>
            
            <p id="modal-loading-message" style="text-align: center; color: var(--color-text-subtle); margin-top: 15px; display: none;"></p>
        </div>
    </div>
    
    <div id="reply-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('reply-modal').style.display='none'">&times;</span>
            <h3><i class="fas fa-reply"></i> Send Response to Customer</h3>
            
            <form id="reply-form">
                <label for="reply-email-to">Customer Email (To):</label>
                <input type="email" id="reply-email-to" name="emailTo" required readonly style="background-color: var(--color-bg-page);">
                
                <div class="form-row">
                    <div>
                        <label for="reply-email-from">Admin Email (From):</label>
                        <input type="email" id="reply-email-from" name="emailFrom" value="support@lollyscollection.com" required>
                    </div>
                    <div>
                        <label for="reply-date">Date Sent:</label>
                        <input type="text" id="reply-date" name="dateSent" required readonly>
                    </div>
                </div>

                <label for="reply-subject">Subject:</label>
                <input type="text" id="reply-subject" name="subject" value="Re: Your Inquiry at Lolly's Collection" required>
                
                <label for="reply-content">Reply Content:</label>
                <textarea id="reply-content" name="content" rows="6" required placeholder="Type your response here..."></textarea>
                
                <button type="submit" class="submit-button" id="send-reply-btn"><i class="fas fa-paper-plane"></i> Send Reply</button>
            </form>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content small-modal">
        <span class="close-button" onclick="document.getElementById('delete-confirm-modal').style.display='none'">&times;</span>
        <h2 style="color: var(--color-danger);"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h2>
        
        <p id="delete-message">Are you sure you want to permanently delete this product? This action cannot be undone.</p>
        
        <p style="margin-top: 15px; font-weight: bold;">Product: <span id="product-to-delete-name"></span></p>

        <div class="modal-actions" style="margin-top: 20px;">
            <button id="confirm-delete-btn" class="btn btn-danger" data-product-id="">Yes, Delete It</button>
            <button class="btn btn-secondary" onclick="document.getElementById('delete-confirm-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>
    
    <div id="auth-gate-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px; text-align: center; padding: 40px;">
            <i class="fas fa-lock" style="font-size: 3rem; color: var(--color-pink-accent); margin-bottom: 20px;"></i>
            <h3 style="border-bottom: none; margin-bottom: 15px;">Admin Access Required</h3>
            <p>You must be logged in as an administrator to access the Lolly's Collection Dashboard.</p>
            <button class="submit-button" onclick="redirectToAuthPage()" style="margin-top: 20px;">
                <i class="fas fa-sign-in-alt"></i> Login Now
            </button>
        </div>
    </div>
    <script>
       // Ensure this URL matches your backend API
const API_BASE_URL = '/api'; 

// Chart instance reference
let salesChartInstance = null;
let allProducts = [];
let deleteProductIdToConfirm = null;

// Global variables for auto-refresh timers
let dashboardIntervalId = null;
let ordersIntervalId = null;
const REFRESH_INTERVAL = 30000; // 30 seconds

// --- Authentication Gate Logic (NEW) ---

/**
 * Redirects the user to the dedicated authentication page.
 */
function redirectToAuthPage() {
    // In a real application, this would redirect to your login page
    // For this environment, we'll simulate the redirect
    console.log('Redirecting to /auth.html for login.');
     window.location.href = '/auth.html'; 
}

/**
 * Checks the authentication status of the user via API.
 */
async function checkAdminAuthentication() {
    try {
        // Simulated API call to a dedicated authentication check endpoint
        const response = await fetch(`${API_BASE_URL}/auth/check`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        });

        if (response.ok) {
            // User is authenticated. Hide modal and proceed.
            document.getElementById('auth-gate-modal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Re-enable scrolling
            
            // Re-enable interaction with the main content area
            document.querySelector('.main-content').style.pointerEvents = 'auto';
            document.querySelector('.sidebar-nav').style.pointerEvents = 'auto';
            
            return true;
        } else {
            // User is NOT authenticated (e.g., 401 Unauthorized or 403 Forbidden)
            const result = await response.json().catch(() => ({ message: 'Unauthenticated' }));
            console.warn('Authentication required:', result.message || 'Not logged in.');
            displayAuthGate();
            return false;
        }

    } catch (error) {
        console.error('Network error during auth check:', error);
        // Treat any network error as unauthenticated access for security
        displayAuthGate();
        return false;
    }
}

/**
 * Displays the modal and disables page interaction.
 */
function displayAuthGate() {
    const authModal = document.getElementById('auth-gate-modal');
    authModal.style.display = 'flex'; // Use flex to better center content vertically
    document.body.style.overflow = 'hidden'; // Prevent scrolling the main page
    
    // Disable interaction with the main content area by preventing clicks
    document.querySelector('.main-content').style.pointerEvents = 'none';
    document.querySelector('.sidebar-nav').style.pointerEvents = 'none';
    
    // Ensure the modal is always on top
    authModal.style.zIndex = '10000'; 
}


// --- Auto Refresh Functions ---

async function autoRefreshDashboard() {
    // Check auth status before running refresh
    if (!(await checkAdminAuthentication())) return; 
    // console.log('Auto-refreshing Dashboard...');
    await fetchDashboardStats();
    await fetchAndRenderSalesChart();
}

async function autoRefreshOrders() {
    // Check auth status before running refresh
    if (!(await checkAdminAuthentication())) return; 
    // console.log('Auto-refreshing Orders...');
    await fetchAndRenderOrders();
}

/**
 * Manages the automatic refresh for a given section.
 * @param {string | null} sectionId - The ID of the section to manage ('dashboard' or 'orders').
 */
function manageAutoRefresh(sectionId) {
    // 1. Clear all existing intervals to prevent overlap
    if (dashboardIntervalId) {
        clearInterval(dashboardIntervalId);
        dashboardIntervalId = null;
    }
    if (ordersIntervalId) {
        clearInterval(ordersIntervalId);
        ordersIntervalId = null;
    }

    // 2. Start the interval for the currently active section
    if (sectionId === 'dashboard') {
        // Run immediately on section load
        autoRefreshDashboard(); 
        // Then start the interval
        dashboardIntervalId = setInterval(autoRefreshDashboard, REFRESH_INTERVAL);
    } else if (sectionId === 'orders') {
        // Run immediately on section load
        autoRefreshOrders();
        // Then start the interval
        ordersIntervalId = setInterval(autoRefreshOrders, REFRESH_INTERVAL);
    }
}


// --- Utility Functions ---

/**
 * Fetches dashboard statistics (customers, pending/completed orders).
 */
async function fetchDashboardStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
        const stats = await response.json(); 

        if (!response.ok) throw new Error(stats.message || 'Failed to fetch dashboard stats.');

        // FIX APPLIED: Using stats.userCount to match the server-side code.
        document.getElementById('stat-customers').textContent = stats.userCount || 0;
        document.getElementById('stat-pending-orders').textContent = stats.pendingOrders || 0;
        document.getElementById('stat-completed-orders').textContent = stats.completedOrders || 0;
        
    } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        document.getElementById('stat-customers').textContent = 'Error';
        document.getElementById('stat-pending-orders').textContent = 'Error';
        document.getElementById('stat-completed-orders').textContent = 'Error';
    }
}

/**
 * Fetches sales data for the line graph. (Kept for completeness, not directly used in the fix)
 */
 async function fetchSalesData() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/monthly-sales`);        const salesData = await response.json(); 

        if (!response.ok) throw new Error(salesData.message || 'Failed to fetch sales data.');
        
        // Mock data structure if real data is empty for chart demonstration
        if (salesData.length === 0) {
            return [
                { month: 'Jan', sales: 1200 },
                { month: 'Feb', sales: 1900 },
                { month: 'Mar', sales: 1500 },
                { month: 'Apr', sales: 2500 },
                { month: 'May', sales: 2100 },
                { month: 'Jun', sales: 2800 },
            ];
        }

        return salesData;
    } catch (error) {
        console.error('Error fetching sales data:', error);
        return []; // Return empty array on failure
    }
}

// Separate function to handle chart rendering and destruction
async function fetchAndRenderSalesChart() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/monthly-sales`);
        if (!response.ok) throw new Error('Failed to fetch sales data.');
        
        const data = await response.json();

        if (data.length === 0) {
            return;
        }

        const chartLabels = data.map(item => item.month); 
        const chartData = data.map(item => parseFloat(item.revenue)); 
        
        renderSalesChart(chartLabels, chartData); 

    } catch (error) {
        console.error('Chart data fetch failed:', error);
        if (salesChartInstance) salesChartInstance.destroy();
        const ctx = document.getElementById('salesChart').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = "16px Arial";
        ctx.fillStyle = "red";
        ctx.textAlign = "center";
        ctx.fillText("Error loading sales trend data.", ctx.canvas.width/2, ctx.canvas.height/2);
    }
}

function renderSalesChart(labels, data) {
    if (salesChartInstance) {
        salesChartInstance.destroy();
    }
    
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    salesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Sales ($)',
                data: data,
                borderColor: 'rgb(194, 24, 91)', 
                backgroundColor: 'rgba(233, 30, 99, 0.2)', 
                tension: 0.3,
                fill: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Sales Amount ($)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// --- Navigation & Routing ---

// Function updated to include auto-refresh management
async function showSection(targetId) {
    // Check auth status before allowing navigation/data loading
    if (!(await checkAdminAuthentication())) return; 

    const navLinks = document.querySelectorAll('.nav-link');
    const contentSections = document.querySelectorAll('.content-section');
    
    contentSections.forEach(section => section.classList.remove('active'));
    navLinks.forEach(link => link.classList.remove('active'));

    const targetSection = document.getElementById(targetId);
    const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
    
    if (targetSection) targetSection.classList.add('active');
    if (targetLink) targetLink.classList.add('active');

    // Manage Auto-Refresh based on active section
    if (targetId === 'dashboard' || targetId === 'orders') {
        manageAutoRefresh(targetId);
    } else {
        manageAutoRefresh(null); // Stop refresh on other tabs
    }

    // Trigger initial data fetch for the active section (or let auto-refresh handle it)
    if (targetId === 'products') fetchAndRenderAdminProducts();
    if (targetId === 'customers') fetchAndRenderCustomers();
    if (targetId === 'messages') fetchMessages(); 
}

// --- DOM Content Loaded Listener ---

document.addEventListener('DOMContentLoaded', () => {
    // START OF NEW LOGIC: Check authentication immediately on load
    checkAdminAuthentication();
    // END OF NEW LOGIC
    
    const navLinks = document.querySelectorAll('.nav-link');
    const initialHash = window.location.hash ? window.location.hash.substring(1) : 'dashboard'; 
    
    window.showAdminSection = showSection; 

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const targetId = this.getAttribute('data-target');
            if (targetId) {
                e.preventDefault();
                showSection(targetId);
                history.pushState(null, '', `#${targetId}`);
            }
        });
    });

    // Initial load
    showSection(document.getElementById(initialHash) ? initialHash : 'dashboard');
    document.getElementById('edit-product-form').addEventListener('submit', handleProductUpdate);
    document.getElementById('product-upload-form').addEventListener('submit', handleProductUpload);
    document.getElementById('confirm-delete-btn').addEventListener('click', async (e) => {
        const productId = parseInt(e.target.getAttribute('data-product-id'));
        if (productId) {
            document.getElementById('delete-confirm-modal').style.display = 'none'; 
            await deleteProduct(productId); 
        }
    });
    
    // Add event listener for the new reply form
    document.getElementById('reply-form').addEventListener('submit', sendReply);
});


// --- CUSTOMER MANAGEMENT (MODIFIED) ---
async function fetchAndRenderCustomers() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const tbody = document.getElementById('customers-tbody');
    tbody.innerHTML = '<tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Fetching customer details...</td></tr>';

    try {
        // Mock data structure including new 'is_active' field (assuming API returns this)
        const mockCustomers = [
            { id: 1, full_name: 'Alice Johnson (Admin)', email: 'alice@example.com', created_at: '2024-05-10', is_admin: true, is_active: true },
            { id: 2, full_name: 'Bob Smith (Active)', email: 'bob@example.com', created_at: '2024-06-21', is_admin: false, is_active: true },
            { id: 3, full_name: 'Charlie Brown (Deactivated)', email: 'charlie@example.com', created_at: '2024-07-01', is_admin: false, is_active: false },
        ];
        
        const response = await fetch(`${API_BASE_URL}/customers`);
        let customers = await response.json(); 

        if (!response.ok || customers.length === 0) {
            console.warn('API call failed or returned empty. Using mock customer data.');
            customers = mockCustomers;
        }

        tbody.innerHTML = ''; 

        if (customers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="no-hover" style="text-align: center;">No registered customers found.</td></tr>';
            return;
        }

        customers.forEach(c => {
            const isUserAdmin = c.is_admin === true || c.is_admin === 1;
            const isActive = c.is_active === true || c.is_active === 1;
            
            const adminBadge = isUserAdmin ? ' (Admin)' : '';
            const statusText = isActive ? 'ACTIVE' : 'DEACTIVATED';
            const badgeClass = isActive ? 'active' : 'deactivated';
            const buttonText = isActive ? 'Deactivate' : 'Activate';
            const buttonClass = isActive ? 'deactivate' : 'activate';

            const row = `
                <tr data-customer-id="${c.id}">
                    <td>${c.id}</td>
                    <td>${c.full_name} ${adminBadge}</td>
                    <td>${c.email}</td>
                    <td>${new Date(c.created_at).toLocaleDateString()}</td>
                    <td><span class="status-badge ${badgeClass}">${statusText}</span></td>
                    <td>
                        <button class="action-btn btn-toggle-status ${buttonClass}" 
                            onclick="toggleCustomerStatus(${c.id}, ${isActive})">
                            ${buttonText}
                        </button>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });

    } catch (error) {
        console.error('Error fetching customers:', error);
        tbody.innerHTML = `<tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-danger);">‚ùå Failed to load customers. Check API endpoint.</td></tr>`;
    }
}

/**
 * Toggles a customer's active status via API after confirmation. (NEW FUNCTION)
 * @param {number} userId - The ID of the user to update.
 * @param {boolean} currentStatus - The current active status (true=Active, false=Deactivated).
 */
window.toggleCustomerStatus = async function(userId, currentStatus) {
    if (!(await checkAdminAuthentication())) return; 

    const newStatus = !currentStatus;
    const action = newStatus ? 'Activate' : 'Deactivate';
    const confirmMessage = `Are you sure you want to ${action} user ID #${userId}? This will immediately affect their login access.`;

    const isConfirmed = await showCustomConfirmation(confirmMessage);
    if (!isConfirmed) return;

    try {
        const response = await fetch(`${API_BASE_URL}/admin/customers/${userId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: newStatus })
        });

        if (response.ok) {
            showToast(`User #${userId} successfully ${action}d.`, 'success');
            // Refresh table to update UI instantly
            fetchAndRenderCustomers(); 
        } else {
            const result = await response.json();
            showToast(`Failed to ${action} user: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Status toggle error:', error);
        showToast('Network error while toggling status.', 'error');
    }
};

// --- ORDER MANAGEMENT (Existing logic maintained) ---
async function fetchAndRenderOrders() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const pendingTbody = document.getElementById('pending-orders-tbody');
    const completedTbody = document.getElementById('completed-orders-tbody');
    pendingTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading pending orders...</td></tr>';
    completedTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading completed orders...</td></tr>';

    try {
         // Mock data if API call fails/is empty for demonstration
        const mockOrders = [
            { id: 101, customer_name: 'Bob Smith', delivery_location: 'New York', total: 55.99, created_at: '2025-07-20', status: 'Pending', items: [{ product_name: 'Ring', quantity: 1, unit_price: 55.99 }] },
            { id: 102, customer_name: 'Eva Green', delivery_location: 'London', total: 120.00, created_at: '2025-07-18', status: 'Shipped', items: [{ product_name: 'Dress', quantity: 2, unit_price: 60.00 }] },
            { id: 103, customer_name: 'Charlie Brown', delivery_location: 'Paris', total: 29.99, created_at: '2025-07-10', status: 'Completed', items: [{ product_name: 'Shoes', quantity: 1, unit_price: 29.99 }] },
        ];
        
        const response = await fetch(`${API_BASE_URL}/orders`); 
        let orders = await response.json(); 

        if (!response.ok || orders.length === 0) {
            console.warn('API call failed or returned empty. Using mock order data.');
            orders = mockOrders;
        }

        pendingTbody.innerHTML = '';
        completedTbody.innerHTML = '';
        let pendingCount = 0;
        let completedCount = 0;

        orders.forEach(o => {
            const statusText = o.status.toUpperCase();
            const statusClass = statusText.toLowerCase().replace(' ', '-');
            const isPending = o.status === 'Pending' || o.status === 'Shipped';
            
            const row = document.createElement('tr');
            row.dataset.orderId = o.id;
            row.innerHTML = `
                <td>#${o.id}</td>
                <td>${o.customer_name || o.customerName}</td>
                <td>${o.delivery_location}</td>
                <td>$${parseFloat(o.total).toFixed(2)}</td>
                <td>${new Date(o.order_date || o.created_at).toLocaleDateString()}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    ${isPending ? 
                        `<button class="action-btn btn-complete" onclick="markOrderAsCompleted(${o.id}, event)">Mark as Completed</button>` :
                        `<button class="table-action-btn btn-view" onclick="viewOrderDetails(${o.id}, event)"><i class="fas fa-eye"></i></button>`
                    }
                </td>
            `;
            
            // Add listener to open modal on row click (excluding the action button click)
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    viewOrderDetails(o.id, e);
                }
            });

            if (isPending) {
                pendingTbody.appendChild(row);
                pendingCount++;
            } else {
                completedTbody.appendChild(row);
                completedCount++;
            }
        });

        if (pendingCount === 0) {
            pendingTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center;">No pending orders!</td></tr>';
        }
        if (completedCount === 0) {
            completedTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center;">No completed orders yet.</td></tr>';
        }

    } catch (error) {
        console.error('Error fetching orders:', error);
        const errorMessage = `<tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-danger);">‚ùå Failed to load orders. Server error.</td></tr>`;
        pendingTbody.innerHTML = errorMessage;
        completedTbody.innerHTML = errorMessage;
    }
}

window.markOrderAsCompleted = async function(orderId, event) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    event.stopPropagation(); 
    
    const isConfirmed = await showCustomConfirmation(`Are you sure you want to mark Order #${orderId} as COMPLETED?`);
    if (!isConfirmed) return;
    
    const button = event.target;
    button.disabled = true;
    button.textContent = '...';

    try {
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'Completed' })
        });

        if (response.ok) {
            fetchAndRenderOrders(); 
            fetchDashboardStats(); 
            showToast(`Order #${orderId} marked as completed.`, 'success');
        } else {
            const result = await response.json();
            showCustomMessage(`Failed to update order: ${result.message}`, 'error');
            button.disabled = false;
            button.textContent = 'Mark as Completed';
        }
    } catch (error) {
        console.error('Update status error:', error);
        showCustomMessage('Network error while updating order status.', 'error');
        button.disabled = false;
        button.textContent = 'Mark as Completed';
    }
}

window.viewOrderDetails = async function(orderId, event) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    if (event) event.stopPropagation();
    
    const modal = document.getElementById('order-details-modal');
    const itemContainer = document.getElementById('modal-items-list');
    const loadingMessage = document.getElementById('modal-loading-message');

    document.getElementById('modal-order-id').textContent = orderId;
    itemContainer.innerHTML = '';
    loadingMessage.textContent = 'Fetching details...';
    loadingMessage.style.display = 'block';
    
    modal.style.display = 'block';

    try {
        const orderResponse = await fetch(`${API_BASE_URL}/orders/${orderId}`);
        const order = (orderResponse.ok) ? await orderResponse.json() : 
            { customer_name: 'Mock Customer', customer_email: 'mock@example.com', delivery_location: '123 Test St', order_date: new Date().toISOString(), total: 99.99 };

        document.getElementById('modal-customer-name').textContent = order.customer_name || 'N/A';
        document.getElementById('modal-customer-email').textContent = order.customer_email || 'N/A';
        document.getElementById('modal-delivery-location').textContent = order.delivery_location || 'N/A';
        document.getElementById('modal-order-date').textContent = new Date(order.order_date || order.created_at).toLocaleString();
        document.getElementById('modal-total-amount').textContent = `$${parseFloat(order.total).toFixed(2)}`;
        
        const itemsResponse = await fetch(`${API_BASE_URL}/orders/${orderId}/items`);
        let items = (itemsResponse.ok) ? await itemsResponse.json() :
            [{ product_name: 'Mock Item A', quantity: 1, unit_price: 49.99 }, { product_name: 'Mock Item B', quantity: 2, unit_price: 25.00 }];
        
        loadingMessage.style.display = 'none';
        
        if (items.length === 0) {
            itemContainer.innerHTML = '<li>No items found.</li>';
            return;
        }

        itemContainer.innerHTML = '';
        items.forEach(item => {
            const li = document.createElement('li');
            const itemTotal = (parseFloat(item.unit_price) * parseInt(item.quantity)).toFixed(2);
            li.innerHTML = `
                <span>${item.product_name}</span>
                <span>${item.quantity} x $${parseFloat(item.unit_price).toFixed(2)} = <strong>$${itemTotal}</strong></span>
            `;
            itemContainer.appendChild(li);
        });

    } catch (error) {
        console.error('Error fetching order details:', error);
        loadingMessage.style.display = 'none';
        itemContainer.innerHTML = `<li style="color: var(--color-danger); text-align: center;">Error loading details: ${error.message}</li>`;
    }
}

// Modal close functionality 
document.querySelector('#order-details-modal .close-btn').onclick = function() {
    document.getElementById('order-details-modal').style.display = "none";
}
window.onclick = function(event) {
    if (event.target == document.getElementById('order-details-modal')) {
        document.getElementById('order-details-modal').style.display = "none";
    }
    // Also close reply modal if clicked outside
    if (event.target == document.getElementById('reply-modal')) {
        document.getElementById('reply-modal').style.display = "none";
    }
}

// --- PRODUCT MANAGEMENT (Existing logic maintained) ---

// Function to Handle Form Submission (Update)
async function handleProductUpdate(e) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form); 
    const productId = formData.get('id');
    const updateBtn = document.getElementById('update-btn');

    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    try {
        const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
            method: 'PUT', 
            body: formData, 
        });

        const result = await response.json();

        if (response.ok) {
            showToast(result.message, 'success');
            document.getElementById('edit-product-form-container').style.display = 'none'; 
            await fetchAndRenderAdminProducts(); 
        } else {
            showToast(`Update failed: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Update Error:', error);
        showToast('Network or client error during update.', 'error');
    } finally {
        updateBtn.disabled = false;
        updateBtn.innerHTML = 'Save Changes';
    }
}

// Product Upload Function
async function handleProductUpload(e) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    e.preventDefault();
    
    const form = e.target;
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');

    const formData = new FormData(form); 
    
    const imageFile = formData.get('productImage');
    if (!imageFile || imageFile.size === 0) {
        showCustomMessage('Please select an image file to upload.', 'error');
        return;
    }

    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    uploadStatus.style.color = 'var(--color-info)';
    uploadStatus.textContent = 'Processing product upload...';

    try {
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'POST',
            body: formData, 
        });

        const result = await response.json();

        if (response.ok) {
            uploadStatus.style.color = 'var(--color-success)';
            uploadStatus.textContent = `‚úÖ Product "${formData.get('name')}" uploaded successfully!`;
            form.reset(); 
            await fetchAndRenderAdminProducts(); 
        } else {
            uploadStatus.style.color = 'var(--color-danger)';
            uploadStatus.textContent = `‚ùå Upload failed: ${result.message || 'Server error.'}`;
        }
    } catch (error) {
        console.error('Upload Error:', error);
        uploadStatus.style.color = 'var(--color-danger)';
        uploadStatus.textContent = `‚ùå Network or client error. Check console.`;
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Product';
    }
}


async function deleteProduct(productId) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    // This is called from the confirm button click listener
    try {
        const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast(`Product #${productId} deleted successfully.`, 'success');
            await fetchAndRenderAdminProducts(); // Refresh list
        } else {
             const result = await response.json();
            showToast(`Deletion failed: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Delete Error:', error);
        showToast('Network error during product deletion.', 'error');
    }
}

// Logout Placeholder 
document.getElementById('logout-link').addEventListener('click', async (e) => {
    e.preventDefault();
    const isConfirmed = await showCustomConfirmation('Are you sure you want to log out?');
    if (!isConfirmed) return;
    
    fetch('/api/logout', { method: 'POST' });
    showToast('Logout simulated! Redirecting to auth page...', 'info');
     redirectToAuthPage(); 
    window.location.href = '/auth.html';
});    


// --- Custom Modal/Message Box Implementation (To replace native alerts/confirms) ---
document.body.insertAdjacentHTML('beforeend', `
    <div id="custom-message-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close-btn" onclick="document.getElementById('custom-message-modal').style.display='none'">&times;</span>
            <h3 id="modal-msg-title" style="border-bottom: none; margin-bottom: 10px;">Message</h3>
            <p id="modal-msg-text"></p>
            <div id="modal-msg-actions" style="margin-top: 20px;">
                <button id="modal-msg-ok" class="action-button">OK</button>
                <button id="modal-msg-cancel" class="action-button" style="background-color: var(--color-text-subtle); margin-left: 10px; display: none;">Cancel</button>
            </div>
        </div>
    </div>
`);

const customMsgModal = document.getElementById('custom-message-modal');
const msgTitle = document.getElementById('modal-msg-title');
const msgText = document.getElementById('modal-msg-text');
const msgOkBtn = document.getElementById('modal-msg-ok');
const msgCancelBtn = document.getElementById('modal-msg-cancel');

function showCustomMessage(message, type = 'info') {
    const titleMap = { 'error': 'Error', 'success': 'Success', 'info': 'Notice' };
    const colorMap = { 'error': 'var(--color-danger)', 'success': 'var(--color-success)', 'info': 'var(--color-info)' };
    
    msgTitle.textContent = titleMap[type] || 'Message';
    msgTitle.style.color = colorMap[type] || 'var(--color-pink-dark)';
    msgText.textContent = message;
    
    msgCancelBtn.style.display = 'none';
    msgOkBtn.textContent = 'OK';
    msgOkBtn.onclick = () => customMsgModal.style.display = 'none';
    
    customMsgModal.style.display = 'flex'; // Use flex to center message modal as well
}

function showCustomConfirmation(message) {
    return new Promise(resolve => {
        msgTitle.textContent = 'Confirmation';
        msgTitle.style.color = 'var(--color-warning)';
        msgText.textContent = message;

        msgCancelBtn.style.display = 'inline-block';
        msgOkBtn.textContent = 'Yes';
        
        const close = (result) => {
            customMsgModal.style.display = 'none';
            resolve(result);
        };
        
        msgOkBtn.onclick = () => close(true);
        msgCancelBtn.onclick = () => close(false);
        
        customMsgModal.style.display = 'flex'; // Use flex to center confirmation modal as well
    });
}
 
// --- Delete Confirmation Modal Implementation ---
async function showDeleteConfirmation(productId) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const product = allProducts.find(p => p.id === productId);

    if (!product) {
        showToast('Error: Product data not found for confirmation.', 'error');
        return;
    }

    deleteProductIdToConfirm = productId;
    
    const productName = product.name;
    document.getElementById('product-to-delete-name').textContent = productName;
    document.getElementById('confirm-delete-btn').setAttribute('data-product-id', productId);
    
    document.getElementById('delete-confirm-modal').style.display = 'block';
}

// --- Toast Notification Implementation ---
/**
 * Displays a temporary, non-blocking toast notification.
 */
function showToast(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    // Ensure the container is defined in the body (needed for pages that lack it)
    if (!container) {
        document.body.insertAdjacentHTML('afterbegin', `<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;"></div>`);
        return showToast(message, type, duration); // Re-run once container exists
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message; 
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10); 

    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
            toast.remove();
        });
    }, duration);
}

// --- Function to Render a Single Product Row ---
function renderProductRow(product) {
    const tableBody = document.getElementById('products-table-body');
    const row = document.createElement('tr');
    
    const formattedPrice = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(product.price);
    
    row.innerHTML = `
        <td>${product.id}</td>
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td>${formattedPrice}</td>
        <td>${product.stock}</td>
        <td><img src="${product.image_url}" alt="${product.name}" style="height: 50px; width: 50px; object-fit: cover;"></td>
        <td>
            <button onclick="editProduct(${product.id})" class="btn-small btn-edit">Edit</button>
            
            <button onclick="showDeleteConfirmation(${product.id})" class="btn-small btn-delete">Delete</button>
        </td>
    `;
    
    tableBody.appendChild(row);
}

// --- Function to Fetch All Products ---
async function fetchAndRenderAdminProducts() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const tableBody = document.getElementById('products-table-body');
    const loadingMessage = document.getElementById('loading-message');
    
    tableBody.innerHTML = ''; 
    loadingMessage.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE_URL}/products`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const products = await response.json();
        allProducts = products; 
        loadingMessage.style.display = 'none'; 

        if (products.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7">No products have been added yet.</td></tr>';
            return;
        }

        products.forEach(product => {
            renderProductRow(product);
        });

    } catch (error) {
        console.error('Error fetching admin products:', error);
        loadingMessage.textContent = '‚ùå Failed to load products. Check console for error details.';
        loadingMessage.style.color = 'var(--color-danger)';
    }
}   
 

// --- Function to Populate Form and Show Container ---
async function editProduct(productId) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const product = allProducts.find(p => p.id == productId);
    
    if (!product) {
        showToast('Product data not available.', 'error');
        return;
    }

    document.getElementById('edit-product-id').value = product.id;
    document.getElementById('edit-name').value = product.name;
    document.getElementById('edit-price').value = product.price;
    document.getElementById('edit-category').value = product.category;
    document.getElementById('edit-stock').value = product.stock;
    document.getElementById('edit-description').value = product.description || '';
    document.getElementById('edit-existing-image-url').value = product.image_url;
    document.getElementById('current-edit-image').src = product.image_url;
    
    document.getElementById('edit-product-form-container').style.display = 'block';
    
    document.getElementById('edit-product-form-container').scrollIntoView({ behavior: 'smooth' });
}


// -----------------------------------------------------
// MESSAGE & REPLY LOGIC (Updated)
// -----------------------------------------------------

const messagesList = document.getElementById('messages-list');
const messagesLoading = document.getElementById('messages-loading');

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

/**
 * Opens the reply modal and pre-fills the customer's email and current date.
 * @param {string} customerEmail - The email address of the customer to reply to.
 */
window.openReplyModal = async function(customerEmail) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const replyModal = document.getElementById('reply-modal');
    
    // 1. Pre-fill customer email
    document.getElementById('reply-email-to').value = customerEmail;
    
    // 2. Set current date
    const now = new Date();
    document.getElementById('reply-date').value = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    
    // 3. Clear content area
    document.getElementById('reply-content').value = '';
    
    // 4. Show modal
    replyModal.style.display = 'block';
}


function renderMessageCard(message) {
    const card = document.createElement('div');
    card.className = 'message-card';
    card.innerHTML = `
        <div>
            <div class="message-header">
                <h4>${message.sender_name || 'N/A'}</h4>
                <p>${message.sender_email || 'No email provided'}</p>
            </div>
            <div class="message-body">
                <p>${message.message_content.replace(/\n/g, '<br>')}</p>
            </div>
        </div>
        <div class="message-footer">
            Received: ${formatDate(message.received_at)}
        </div>
        <div class="message-actions">
            <button class="action-btn" 
                    onclick="openReplyModal('${message.sender_email}')">
                <i class="fas fa-reply"></i> Respond
            </button>
        </div>
    `;
    return card;
}

async function fetchMessages() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    messagesList.innerHTML = ''; 
    messagesLoading.textContent = 'Loading messages...';
    messagesLoading.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE_URL}/admin/messages`); 
        
        if (!response.ok) {
            messagesLoading.style.display = 'none';
            const error = await response.json().catch(() => ({ message: 'Unauthenticated or server error.' }));
            messagesList.innerHTML = `<p class="status-error" style="color: var(--color-danger);">Error fetching messages: ${error.message || 'Server error. Check if admin route is secured/defined.'}</p>`;
            return;
        }

        const messages = await response.json();
        
        messagesLoading.style.display = 'none';

        if (messages.length === 0) {
            messagesList.innerHTML = '<p class="status-info" style="color: var(--color-text-subtle);">No customer messages found.</p>';
        } else {
            messages.forEach(message => {
                messagesList.appendChild(renderMessageCard(message));
            });
        }

    } catch (error) {
        console.error('Network error during message fetch:', error);
        messagesLoading.style.display = 'none';
        messagesList.innerHTML = '<p class="status-error" style="color: var(--color-danger);">A network error occurred. Could not load messages.</p>';
    }
}

/**
 * Handles the submission of the reply form and sends the email via API.
 */
async function sendReply(e) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    e.preventDefault();
    
    const form = e.target;
    const sendBtn = document.getElementById('send-reply-btn');

    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    const payload = {
        to: document.getElementById('reply-email-to').value,
        from: document.getElementById('reply-email-from').value,
        subject: document.getElementById('reply-subject').value,
        content: document.getElementById('reply-content').value,
    };
    
    try {
        // Assuming a dedicated API endpoint for sending email replies
        const response = await fetch(`${API_BASE_URL}/admin/messages/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            document.getElementById('reply-modal').style.display = 'none';
            form.reset();
            showToast(`Reply sent successfully to ${payload.to}!`, 'success');
        } else {
             const result = await response.json();
            showToast(`Failed to send email: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Email send error:', error);
        showToast('Network error while sending reply.', 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
    }
}
   </script>
    
</body>
</html>